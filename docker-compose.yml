services:
  # New Team Collaboration App Frontend
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://localhost:3001
      - VITE_EXCALIDRAW_URL=http://localhost:8080
    volumes:
      - ./app:/app
      - /app/node_modules
    depends_on:
      - api

  # New Backend API
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=development
      - PORT=3001
      - FRONTEND_URL=http://localhost:3000
      - JWT_SECRET=your-jwt-secret-change-in-production
      - DATABASE_URL=postgresql://teamhub:teamhub123@postgres:5432/teamhub
      - MONGODB_URL=mongodb://mongo:27017/excalidraw
    volumes:
      - ./api:/api
      - /api/node_modules
    depends_on:
      - postgres
      - mongo

  # PostgreSQL for user management and whiteboard metadata
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=teamhub
      - POSTGRES_USER=teamhub
      - POSTGRES_PASSWORD=teamhub123
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"

  # Existing Excalidraw Frontend (renamed to avoid confusion)
  excalidraw-frontend:
    image: alswl/excalidraw:v0.18.0-fork-b2
    environment:
      - VITE_APP_BACKEND_V2_GET_URL=http://127.0.0.1:8083/api/v2/scenes/
      - VITE_APP_BACKEND_V2_POST_URL=http://127.0.0.1:8083/api/v2/scenes/
      - VITE_APP_WS_SERVER_URL=http://127.0.0.1:8084
      - VITE_APP_FIREBASE_CONFIG={}
      - VITE_APP_HTTP_STORAGE_BACKEND_URL=http://127.0.0.1:8083/api/v2
      - VITE_APP_STORAGE_BACKEND=http
    ports:
      - "8080:80"
    depends_on:
      - storage
      - room

  # Existing Storage Backend
  storage:
    image: alswl/excalidraw-storage-backend:v2023.11.11
    restart: always
    environment:
      - PORT=8081
      - STORAGE_URI=mongodb://mongo:27017/excalidraw
    ports:
      - "8083:8081"
    depends_on:
      - mongo

  # Existing Room Server
  room:
    image: excalidraw/excalidraw-room:sha-49bf529
    ports:
      - "8084:80"

  # MongoDB for Excalidraw scene data
  mongo:
    image: mongo:7.0.5
    environment:
      - MONGO_INITDB_DATABASE=excalidraw
    volumes:
      - mongo_data:/data/db
    ports:
      - "27017:27017"

volumes:
  postgres_data:
  mongo_data:
